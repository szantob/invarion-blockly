<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Blockly Demo: Fixed Blockly</title>
  <script src="./js/blockly/blockly_compressed.js"></script>
  <script src="./js/blockly/blocks_compressed.js"></script>
  <script src="./js/blockly/msg/js/en.js"></script>
  <script src="./js/doll/conceptmodel.js"></script>
  <script src="./js/doll/vocabulary.js"></script>
  <script src="./js/doll/datamodel.js"></script>
  <script src="./js/doll/taxonomy.js"></script>
  <script src="./js/blocklyDOM.js"></script>
  <style src="./css/style.css"></style>
  <script>
	var workspace_xml = 
		'<xml xmlns="https://developers.google.com/blockly/xml" id="toolbox" style="display: none">'+
		  '<category name="Concept Model Blocks" custom="CONCEPTMODEL"></category>'+
		  '<category name="Vocabulary" custom="VOCABULARY"></category>'+
		  '<category name="Taxonomy" custom="TAXONOMY"></category>'+
		  '<category name="Data Model" custom="DATAMODEL"></category>'+
		  '<category name="Variables">'+
			'<block type="logic_null"></block>'+
			'<block type="math_number"><field name="NUM">0</field></block>'+
			'<block type="math_constant"><field name="CONSTANT">PI</field></block>'+
			'<block type="logic_boolean"><field name="BOOL">TRUE</field></block>'+
			'<block type="text"><field name="TEXT"></field></block>'+
		  '</category>'+
		'</xml>';
		var onSave = function(){};
		var onInit = function(){};
		var onNewVocabularyEntry = function(){};
  </script>
</head>
<body>
	<nav width="100%" height="100px">
		<button onclick="onInit()">Clear</button>
		<button onclick="onSave()">Save</button>
		<button onclick="onNewVocabularyEntry()">New Vocabulary entry</button>
	</nav>
	<div id="blocklyDiv" style="height: 720px; width: 1280px;"></div>

	<xml xmlns="https://developers.google.com/blockly/xml" id="toolbox" style="display: none">
		<category name="Concept Model Blocks">
		</category>
	</xml>
	<xml xmlns="https://developers.google.com/blockly/xml" id="workspaceBlocks" style="display: none"></xml>

	<script>
	var toolbox = document.getElementById("toolbox");

	var options = { 
		toolbox : toolbox, 
		collapse : true, 
		comments : true, 
		disable : true, 
		maxBlocks : Infinity, 
		trashcan : true, 
		horizontalLayout : false, 
		toolboxPosition : 'start', 
		css : true, 
		media : 'https://blockly-demo.appspot.com/static/media/', 
		rtl : false, 
		scrollbars : true, 
		sounds : true, 
		oneBasedIndex : true
	};
	
	
	var toolboxUpdate = function(){
		workspace.updateToolbox(workspace_xml);
	}
	
	var workspace = Blockly.inject('blocklyDiv', options);
	workspace.registerToolboxCategoryCallback('VOCABULARY', vocabularyCallback);
	workspace.registerToolboxCategoryCallback('TAXONOMY', taxonomyCallback);
	workspace.registerToolboxCategoryCallback('DATAMODEL', datamodelCallback);
	workspace.registerToolboxCategoryCallback('CONCEPTMODEL', conceptmodelCallback);
	workspace.registerButtonCallback('vocabularyNewEntry', onNewVocabularyEntry);
	workspace.registerButtonCallback('taxonomyNewEntry', taxonomyNewEntryCallback);
	var workspaceBlocks = document.getElementById("workspaceBlocks"); 
	Blockly.Xml.domToWorkspace(workspaceBlocks, workspace);
	toolboxUpdate();
	
	onSave = function(){
		var wsXml = Blockly.Xml.workspaceToDom(workspace);
		console.log(wsXml);
	};
	onInit = function(){
		var wsXml = Blockly.Xml.workspaceToDom(workspace);
		workspace.clear();
		var wsDOM = new BlocklyDOM(wsXml);
		
		var nameBlock = createBlock("concept_model_dec_name","concept_model_name", 20,20);
		wsDOM.add(nameBlock);
		var vocabularyBlock = createBlock("concept_model_dec_vocabulary","concept_model_vocabulary", 20,50);
		wsDOM.add(vocabularyBlock);
		var taxonomyBlock = createBlock("concept_model_dec_taxonomy","concept_model_taxonomy", 320,50);
		wsDOM.add(taxonomyBlock);
		var datamodelBlock = createBlock("concept_model_dec_datamodel","concept_model_datamodel", 620,50);
		wsDOM.add(datamodelBlock);
		
		wsXml = wsDOM.toXml();
		workspace.clear();
		Blockly.Xml.domToWorkspace(wsXml, workspace);
	};
	onNewVocabularyEntry = function(){
		var itemName = prompt("New vocabulary entry name:", "Thing");
		if (itemName == null || itemName == "") {
		} else {
			Vocabulary.addItem(itemName);
			toolboxUpdate();
			/*var txt = "";
			var xml = Blockly.Xml.workspaceToDom(workspace)
			x = xml.getElementsByTagName('block');
			xLen = x.length;

			for (i = 0; i <xLen; i++) {
				txt += x[i].childNodes[0].nodeValue + " ";
			}
			console.log(txt);*/
		}
		
		return;
	};
  </script>
</body>
</html>
